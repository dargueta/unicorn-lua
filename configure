#!/bin/sh

LUA=$(which lua)
LUAROCKS=$(which luarocks)

USAGE="
Usage:
$0 [-h] [-l PATH] [-r PATH]

-h
    Show this help message.

-d
    Build the library in debug mode. If not passed, defaults to release mode.

-l PATH
    The path to the Lua executable to build the library for.
    Default: $LUA

-r PATH
    The path to the LuaRocks executable to use for installing rocks needed for
    testing. Only needed for CI and local development.
    Default: ${LUAROCKS:-(not installed)}
"

build_type=release

while getopts "dhl:r:" C
do
    case "$C" in
        h )
          echo "$USAGE"
          exit 0
          ;;
        d ) build_type=debug ;;
        l ) LUA=$(realpath "$OPTARG") ;;
        r ) LUAROCKS=$(realpath "$OPTARG") ;;
        * )
          echo "Unrecognized argument '$C'"
          exit 1
          ;;
    esac
done

make -f profile.mk -B LUA="${LUA}" LUAROCKS="${LUAROCKS}" BUILD_TYPE=${build_type}
